\section{Computation of the derive of $h_i$}
\label{ap:computationof_h}

The definitions with $r_i = |\textbf{x}_i - \textbf{x}|$.  

\begin{equation*}
    h_i(\textbf{x},t,\FF)
    = 
    \frac{1}{N(\textbf{x},t,\FF)}
    \prod_j
    H(r_j - r_i)
\end{equation*}
and 
\begin{equation*}
    N(\textbf{x},t\FF)
    = \sum_i \prod_j 
    H(r_j - r_i)
\end{equation*}

The Gradient of this function gives
\begin{equation*}
    \pddt  h_i(\textbf{x},t,\FF)
    = 
    -  \frac{\pddt N(\textbf{x},t,\FF)}{N(\textbf{x},t,\FF)^2}
    \prod_j
    H(r_j - r_i)
    + \frac{1}{N(\textbf{x},t,\FF)}
    \pddt \prod_j
    H(r_j - r_i)
\end{equation*}
\begin{equation*}
    \pddx  h_i(\textbf{x},t,\FF)
    = 
    -  \frac{\pddx N(\textbf{x},t,\FF)}{N(\textbf{x},t,\FF)^2}
    \prod_j
    H(r_j - r_i)
    + \frac{1}{N(\textbf{x},t,\FF)}
    \pddx \prod_j
    H(r_j - r_i)
\end{equation*}
with, 
\begin{equation*}
    \pddt 
    \prod_j
    H(r_j - r_i)
    = 
    \sum_k 
    \delta(r_k - r_i)
    (\textbf{u}_k  \cdot \hat{\textbf{r}}_k - \textbf{u}_i  \cdot \hat{\textbf{r}}_i)
    \prod_{j\neq k}
    H(r_j - r_i)
\end{equation*}
\begin{equation*}
    \pddx
    \prod_j
    H(r_j - r_i)
    = 
    \sum_k 
    \delta(r_k - r_i)
    ( \hat{\textbf{r}}_i -  \hat{\textbf{r}}_k)
    \prod_{j\neq k}
    H(r_j - r_i)
\end{equation*}

\begin{align*}
    \pddt r_k
    = \pddt [(\textbf{x}_k(\FF,t) - \textbf{x})\cdot (\textbf{x}_k(\FF,t) - \textbf{x})]^{1/2}\\
    = 
    2 \textbf{u}_k(\FF,t)  \cdot (\textbf{x}_k(\FF,t) - \textbf{x})
    \frac{1}{2}[(\textbf{x}_k(\FF,t) - \textbf{x})\cdot (\textbf{x}_k(\FF,t) - \textbf{x})]^{- 1/2}
    = 
    \textbf{u}_k  \cdot \hat{\textbf{r}}_k
\end{align*}
\begin{align*}
    \pddx r_k
    = \pddx [(\textbf{x}_k(\FF,t) - \textbf{x})\cdot (\textbf{x}_k(\FF,t) - \textbf{x})]^{1/2}
    = - \hat{\textbf{r}}_k
\end{align*}

The $N$ function derivative gives 
\begin{equation*}
    \pddt 
    N 
    = \pddt 
    \sum_i \prod_j
    H(r_j - r_i)
    = 
    \sum_i 
    \sum_k 
    \delta(r_k - r_i)
    (\textbf{u}_k  \cdot \hat{\textbf{r}}_k - \textbf{u}_i  \cdot \hat{\textbf{r}}_i)
    \prod_{j\neq k}
    H(r_j - r_i) = 0 
\end{equation*}

Thus, we have \citet{zhang2021ensemble} 
\begin{align*}
    \pddt  h_i(\textbf{x},t,\FF)
    = 
    \frac{1}{N(\textbf{x},t,\FF)}
    \sum_k 
    \delta(r_k - r_i)
    (\textbf{u}_k  \cdot \hat{\textbf{r}}_k - \textbf{u}_i  \cdot \hat{\textbf{r}}_i)
    \prod_{j\neq k}
    H(r_j - r_i)
    \\
    \textbf{u}_i \cdot \grad h_i(\textbf{x},t,\FF)
    = 
    \frac{1}{N(\textbf{x},t,\FF)}
    \sum_k 
    \delta(r_k - r_i)
    (\textbf{u}_i  \cdot \hat{\textbf{r}}_i -  \textbf{u}_i  \cdot\hat{\textbf{r}}_k)
    \prod_{j\neq k}
    H(r_j - r_i)
    \\
\end{align*}
Since $\delta(r_k - r_i)$ we have $r_k = r_i$ therefor $H(r_k - r_i) = H(0) = 1 $
\begin{align*}
    \pddt  h_i(\textbf{x},t,\FF)
    = 
    \sum_k 
    \delta(r_k - r_i)
    (\textbf{u}_k  \cdot \hat{\textbf{r}}_k - \textbf{u}_i  \cdot \hat{\textbf{r}}_i)
    h_i
    \\
    \textbf{u}^0 \cdot \grad h_i(\textbf{x},t,\FF)
    = 
    \sum_k 
    \delta(r_k - r_i)
    (\textbf{u}^0  \cdot \hat{\textbf{r}}_i -  \textbf{u}^0  \cdot\hat{\textbf{r}}_k)
    h_i
    \\
\end{align*}
Idea, maybe if i sum on i it cancel ? 
\begin{align*}
    \pddt  h_i(\textbf{x},t,\FF) +\textbf{u}^0 \cdot \grad h_i(\textbf{x},t,\FF)
    &= 
    \sum_k 
    \delta(r_k - r_i)
    (\textbf{u}_k  \cdot \hat{\textbf{r}}_k  - \textbf{u}_i  \cdot \hat{\textbf{r}}_k)
    h_i
    \\
    &= 
    \sum_k 
    \delta(r_k - r_i)
    [(\textbf{u}_k  - \textbf{u}^0) \cdot \hat{\textbf{r}}_k - (\textbf{u}_i - \textbf{u}^0)  \cdot \hat{\textbf{r}}_i]
    h_i
    \\
\end{align*}
This can be treated in a similar way that previously

ensemble average these equations gives 
